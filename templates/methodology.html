{% extends "base.html" %}

{% block title %}Methodology - Third Base Send Model{% endblock %}

{% block head %}
<style>
    .tab-nav {
        display: flex;
        gap: var(--space-2);
        margin-bottom: var(--space-5);
        border-bottom: 2px solid var(--gray-200);
        padding-bottom: var(--space-2);
    }
    .tab-nav a {
        padding: var(--space-2) var(--space-4);
        text-decoration: none;
        color: var(--gray-600);
        font-weight: 500;
        border-radius: 6px 6px 0 0;
        transition: all 0.2s;
    }
    .tab-nav a:hover {
        color: var(--gray-800);
        background: var(--gray-100);
    }
    .tab-nav a.active {
        color: var(--primary);
        background: var(--primary-light);
        border-bottom: 2px solid var(--primary);
        margin-bottom: -2px;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .viz-container {
        background: var(--gray-50);
        border-radius: 8px;
        padding: var(--space-4);
        margin: var(--space-4) 0;
    }
    .bar-chart {
        display: flex;
        align-items: flex-end;
        gap: 4px;
        height: 150px;
        padding: var(--space-3) 0;
    }
    .bar-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
    }
    .bar {
        width: 100%;
        max-width: 40px;
        background: var(--primary);
        border-radius: 4px 4px 0 0;
        transition: all 0.3s;
    }
    .bar:hover {
        opacity: 0.8;
    }
    .bar-label {
        font-size: 0.7rem;
        color: var(--gray-600);
        margin-top: 4px;
        text-align: center;
    }
    .bar-value {
        font-size: 0.65rem;
        color: var(--gray-500);
        margin-bottom: 2px;
    }
    .timeline-viz {
        position: relative;
        height: 120px;
        background: linear-gradient(to right, #fef2f2 0%, #fef2f2 40%, #fffbeb 40%, #fffbeb 50%, #f0fdf4 50%, #f0fdf4 100%);
        border-radius: 8px;
        margin: var(--space-4) 0;
        overflow: hidden;
    }
    .timeline-track {
        position: absolute;
        top: 50%;
        left: 5%;
        right: 5%;
        height: 4px;
        background: var(--gray-300);
        transform: translateY(-50%);
    }
    .timeline-marker {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .timeline-label {
        position: absolute;
        font-size: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
    }
    .zone-label {
        position: absolute;
        bottom: 8px;
        font-size: 0.7rem;
        color: var(--gray-600);
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <section class="section">
        <div class="page-header">
            <h1>Methodology</h1>
            <p>Understanding how the model evaluates third base coach decisions.</p>
        </div>

        <!-- Sub-tabs -->
        <div class="tab-nav">
            <a href="#model" class="active" onclick="showTab('model', event)">Model</a>
            <a href="#calculations" onclick="showTab('calculations', event)">Calculations</a>
        </div>

        <!-- MODEL TAB -->
        <div id="model" class="tab-content active">
            <!-- The Problem -->
            <div class="card" style="margin-bottom: var(--space-5);">
                <div class="card-header">
                    <h3 class="card-title">The Core Question</h3>
                </div>
                <p style="color: var(--gray-700); margin-bottom: var(--space-4);">
                    When a single is hit with a runner on second base, should the third base coach send the runner home or hold them at third? This model answers that question using <strong>Win Probability</strong> rather than outcomes.
                </p>

                <!-- Visual: Decision Tree -->
                <div class="viz-container">
                    <div style="text-align: center; margin-bottom: var(--space-3);">
                        <strong style="color: var(--gray-700);">The Send/Hold Decision</strong>
                    </div>
                    <div style="display: flex; justify-content: center; gap: var(--space-6); flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="background: var(--success); color: white; padding: var(--space-3) var(--space-4); border-radius: 8px; font-weight: 600;">SEND</div>
                            <div style="margin-top: var(--space-2); font-size: 0.85rem; color: var(--gray-600);">
                                <div style="color: var(--success);">Runner scores (97%)</div>
                                <div style="color: var(--danger);">Runner out (3%)</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; color: var(--gray-400); font-weight: 600;">vs</div>
                        <div style="text-align: center;">
                            <div style="background: var(--warning); color: white; padding: var(--space-3) var(--space-4); border-radius: 8px; font-weight: 600;">HOLD</div>
                            <div style="margin-top: var(--space-2); font-size: 0.85rem; color: var(--gray-600);">
                                <div>Runner stays at 3rd</div>
                                <div>Still has chance to score</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Win Probability Framework -->
            <div class="card" style="margin-bottom: var(--space-5);">
                <div class="card-header">
                    <h3 class="card-title">Win Probability Framework</h3>
                </div>
                <p style="color: var(--gray-700); margin-bottom: var(--space-4);">
                    Decisions are evaluated using <strong>Win Probability (WP)</strong>, which naturally weights each run by game leverage. A run in a tie game in the 9th is worth more than a run up 5 in the 3rd.
                </p>

                <div class="formula-block" style="margin-bottom: var(--space-4);">
                    <div style="margin-bottom: var(--space-3);">
                        <strong>Expected WP if Send:</strong><br>
                        WP_send = P(score) &times; WP(run scores) + (1 - P(score)) &times; WP(out at home)
                    </div>
                    <div style="margin-bottom: var(--space-3);">
                        <strong>Expected WP if Hold:</strong><br>
                        WP_hold = WP(runner at 3B, batter at 1B)
                    </div>
                    <div>
                        <strong>Decision Rule:</strong> Send if WP_send > WP_hold
                    </div>
                </div>

                <!-- Visual: Run Value by Game State -->
                <div class="viz-container">
                    <div style="text-align: center; margin-bottom: var(--space-3);">
                        <strong style="color: var(--gray-700);">Run Value Changes by Game State</strong>
                        <div style="font-size: 0.8rem; color: var(--gray-500);">How much 1 run is worth in Win Probability</div>
                    </div>
                    <div class="bar-chart">
                        <div class="bar-group">
                            <div class="bar-value">5%</div>
                            <div class="bar" style="height: 25%; background: var(--gray-400);"></div>
                            <div class="bar-label">Up 5<br>3rd inn</div>
                        </div>
                        <div class="bar-group">
                            <div class="bar-value">8%</div>
                            <div class="bar" style="height: 40%; background: var(--gray-500);"></div>
                            <div class="bar-label">Up 2<br>5th inn</div>
                        </div>
                        <div class="bar-group">
                            <div class="bar-value">12%</div>
                            <div class="bar" style="height: 60%; background: var(--secondary);"></div>
                            <div class="bar-label">Tied<br>7th inn</div>
                        </div>
                        <div class="bar-group">
                            <div class="bar-value">18%</div>
                            <div class="bar" style="height: 90%; background: var(--primary);"></div>
                            <div class="bar-label">Tied<br>9th inn</div>
                        </div>
                        <div class="bar-group">
                            <div class="bar-value">20%</div>
                            <div class="bar" style="height: 100%; background: var(--success);"></div>
                            <div class="bar-label">Down 1<br>Bot 9</div>
                        </div>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--gray-600); text-align: center; margin-top: var(--space-2);">
                        The same run can be worth 4x more in a close late-game situation
                    </p>
                </div>
            </div>

            <!-- Scoring Probability -->
            <div class="card" style="margin-bottom: var(--space-5);">
                <div class="card-header">
                    <h3 class="card-title">Scoring Probability Model</h3>
                </div>
                <p style="color: var(--gray-700); margin-bottom: var(--space-4);">
                    The key input is <strong>P(score)</strong>: the probability the runner scores if sent. This is estimated using logistic regression trained on 22 features from Statcast data.
                </p>

                <h4 style="margin-bottom: var(--space-3);">Primary Features</h4>
                <div class="feature-grid" style="margin-bottom: var(--space-4);">
                    <div class="feature-item">
                        <div class="feature-icon">S</div>
                        <div>
                            <div class="feature-name">Runner Sprint Speed</div>
                            <div class="feature-desc">Statcast-tracked (ft/s)</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">A</div>
                        <div>
                            <div class="feature-name">Fielder Arm Strength</div>
                            <div class="feature-desc">Max throw velocity (mph)</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">D</div>
                        <div>
                            <div class="feature-name">Throw Distance</div>
                            <div class="feature-desc">Catch location to home (ft)</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">T</div>
                        <div>
                            <div class="feature-name">Hang Time</div>
                            <div class="feature-desc">Ball flight duration (s)</div>
                        </div>
                    </div>
                </div>

                <!-- Visual: Scoring Window Spectrum -->
                <div class="viz-container">
                    <div style="text-align: center; margin-bottom: var(--space-3);">
                        <strong style="color: var(--gray-700);">Scoring Window: Runner vs. Throw Timing</strong>
                    </div>
                    <div class="timeline-viz">
                        <div class="timeline-track"></div>
                        <!-- Markers -->
                        <div class="timeline-marker" style="left: 20%; background: var(--danger);"></div>
                        <div class="timeline-marker" style="left: 45%; background: var(--warning);"></div>
                        <div class="timeline-marker" style="left: 75%; background: var(--success);"></div>
                        <!-- Labels -->
                        <div class="timeline-label" style="left: 20%; top: 15%; transform: translateX(-50%);">-1.0s</div>
                        <div class="timeline-label" style="left: 45%; top: 15%; transform: translateX(-50%);">0s</div>
                        <div class="timeline-label" style="left: 75%; top: 15%; transform: translateX(-50%);">+1.5s</div>
                        <!-- Zone labels -->
                        <div class="zone-label" style="left: 20%; width: 40%;">Throw beats runner</div>
                        <div class="zone-label" style="left: 45%; width: 10%;">Close</div>
                        <div class="zone-label" style="left: 75%; width: 30%;">Runner beats throw</div>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--gray-600); text-align: center;">
                        Positive window = runner has margin to score. Negative = throw arrives first.
                    </p>
                </div>

                <h4 style="margin-bottom: var(--space-3);">Model Performance</h4>
                <div class="grid-3" style="margin-bottom: var(--space-4);">
                    <div style="text-align: center;">
                        <div style="font-size: 1.75rem; font-weight: 700; font-family: var(--font-mono); color: var(--secondary);">0.723</div>
                        <div style="font-size: 0.75rem; color: var(--gray-600); text-transform: uppercase;">ROC AUC</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.75rem; font-weight: 700; font-family: var(--font-mono); color: var(--success);">97.2%</div>
                        <div style="font-size: 0.75rem; color: var(--gray-600); text-transform: uppercase;">Calibration</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.75rem; font-weight: 700; font-family: var(--font-mono);">22</div>
                        <div style="font-size: 0.75rem; color: var(--gray-600); text-transform: uppercase;">Features</div>
                    </div>
                </div>
            </div>

            <!-- Decision Classification -->
            <div class="card" style="margin-bottom: var(--space-5);">
                <div class="card-header">
                    <h3 class="card-title">Decision Classification</h3>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Classification</th>
                                <th>What Happened</th>
                                <th>Model Says</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="badge badge-success">Correct Send</span></td>
                                <td>Runner was sent</td>
                                <td>WP_send > WP_hold</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-success">Correct Hold</span></td>
                                <td>Runner was held</td>
                                <td>WP_hold &ge; WP_send</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-danger">Missed Opportunity</span></td>
                                <td>Runner was held</td>
                                <td>WP_send > WP_hold</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-warning">Suboptimal Send</span></td>
                                <td>Runner was sent</td>
                                <td>WP_hold > WP_send</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Limitations -->
            <div class="callout callout-warning">
                <h4>Limitations</h4>
                <ul style="margin: 0; padding-left: var(--space-4);">
                    <li style="margin-bottom: var(--space-2);">
                        <strong>Selection Bias:</strong> Coaches send runners selectively, producing 97% success rates. The model is trained on this selected sample.
                    </li>
                    <li style="margin-bottom: var(--space-2);">
                        <strong>Estimated Inputs:</strong> Fielder catch locations and runner reaction times are estimated from trajectory data.
                    </li>
                    <li>
                        <strong>Unmodeled Factors:</strong> Catcher positioning, relay throws, and defensive shifts are not captured.
                    </li>
                </ul>
            </div>
        </div>

        <!-- CALCULATIONS TAB -->
        <div id="calculations" class="tab-content">
            <!-- Fielder Positioning -->
            <div class="callout" style="margin-bottom: var(--space-5);">
                <h3>Fielder Starting Position</h3>
                <p><strong>What it is:</strong> Where the outfielder was standing when the ball was hit.</p>
                <p><strong>Source:</strong> <a href="https://baseballsavant.mlb.com/visuals/fielder-positioning-all" target="_blank">Baseball Savant Fielder Positioning</a> data.</p>
                <ul>
                    <li><strong>Player-specific positions:</strong> Actual average starting depth and angle for each outfielder</li>
                    <li><strong>League average fallback:</strong> LF ~297 ft, CF ~321 ft, RF ~296 ft</li>
                </ul>
            </div>

            <!-- Time to Field -->
            <div class="callout" style="margin-bottom: var(--space-5);">
                <h3>Time to Field</h3>
                <p><strong>What it is:</strong> Time from bat contact until the fielder picks up the ball.</p>
                <p><strong>How it's calculated:</strong> Different approaches based on launch angle:</p>
                <ul>
                    <li><strong>Ground balls (LA < 10°):</strong> Ball lands quickly then rolls. Total = distance ÷ ground speed.</li>
                    <li><strong>Line drives (LA 10-25°):</strong> Fastest balls—horizontal velocity dominates.</li>
                    <li><strong>Fly balls (LA > 25°):</strong> Projectile motion physics determines hang time.</li>
                </ul>
            </div>

            <!-- Throw Time -->
            <div class="callout" style="margin-bottom: var(--space-5);">
                <h3>Throw Time</h3>
                <p><strong>What it is:</strong> Time from fielding the ball until the throw reaches home.</p>
                <p><strong>Components:</strong></p>
                <ul>
                    <li><strong>Transfer time</strong> (catch to release): 1.1-1.4s depending on catch type. Running catches are faster (momentum toward home).</li>
                    <li><strong>Flight time</strong>: throw_distance ÷ arm_strength × 1.2 (arc factor)</li>
                </ul>
            </div>

            <!-- Scoring Window -->
            <div class="callout" style="margin-bottom: var(--space-5);">
                <h3>Scoring Window</h3>
                <p><strong>What it is:</strong> Time margin between runner arrival and throw arrival at home.</p>
                <div class="formula-block">
                    <div>Defense time = hang_time + throw_time + catcher_tag (1.0s)</div>
                    <div>Runner time = 180 ft ÷ runner_speed + runner_delay</div>
                    <div><strong>Scoring window = Defense time - Runner time</strong></div>
                </div>
                <p style="margin-top: var(--space-3);"><strong>Positive</strong> = runner beats throw. <strong>Negative</strong> = throw beats runner.</p>
            </div>

            <!-- Scoring Probability Blending -->
            <div class="callout" style="margin-bottom: var(--space-5);">
                <h3>Scoring Probability Blending</h3>
                <p><strong>Why we blend:</strong> The ML model is trained on plays where coaches sent runners—pre-selected to be high-probability. For borderline plays, we trust physics more.</p>
                <p><strong>Blending logic:</strong></p>
                <ul>
                    <li>Scoring window ≥ 2s: 100% ML estimate (easy score)</li>
                    <li>Scoring window 1-2s: 80% ML, 20% physics</li>
                    <li>Scoring window 0-1s: 40-60% ML, 40-60% physics</li>
                    <li>Scoring window < 0: Mostly physics (throw beats runner)</li>
                </ul>
            </div>

            <!-- Win Probability -->
            <div class="callout callout-info" style="margin-bottom: var(--space-5);">
                <h3>Win Probability Values</h3>
                <p><strong>Source:</strong> Historical MLB data for each base-out-inning-score state.</p>
                <ul>
                    <li><strong>WP if Send:</strong> P(score) × WP(run scores) + (1-P(score)) × WP(out at home)</li>
                    <li><strong>WP if Hold:</strong> WP with runner on 3rd, batter on 1st</li>
                    <li><strong>Extra innings:</strong> Accounts for ghost runner rule (runner on 2B to start each half-inning)</li>
                </ul>
            </div>

            <!-- Net Runs -->
            <div class="callout" style="margin-bottom: var(--space-5);">
                <h3>Net Runs Calculation</h3>
                <p><strong>What it is:</strong> Total run value gained or lost from decisions.</p>
                <p><strong>Formula:</strong> <code>Net Runs = WP_delta × 10</code></p>
                <p>The factor of 10 converts Win Probability to runs (historically, 1 win ≈ 10 runs).</p>
                <ul>
                    <li>Correct decision: positive contribution</li>
                    <li>Wrong decision: negative contribution (runs left on table)</li>
                </ul>
            </div>

            <!-- Data Sources -->
            <div class="callout" style="background: var(--gray-100);">
                <h3>Data Sources (Not Estimated)</h3>
                <p>These come directly from Statcast:</p>
                <div class="grid-2" style="gap: var(--space-3);">
                    <ul style="margin: 0;">
                        <li>Exit velocity (mph)</li>
                        <li>Launch angle (degrees)</li>
                        <li>Hit coordinates & distance</li>
                    </ul>
                    <ul style="margin: 0;">
                        <li>Runner sprint speed</li>
                        <li>Fielder arm strength</li>
                        <li>Game state (score, inning, outs)</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
function showTab(tabId, event) {
    event.preventDefault();

    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    // Remove active from all nav links
    document.querySelectorAll('.tab-nav a').forEach(link => {
        link.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}
</script>
{% endblock %}
